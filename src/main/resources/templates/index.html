<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MovieMania.com no MovieMania</title>
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3418/3418886.png">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
	body {
	    font-family: 'Roboto', sans-serif;
	    background-color: #14181c;
	    color: #e0e0e0;
	    margin: 0;
	    padding: 0;
	}
	.top-nav {
	    background-color: #14181c;
	    padding: 10px 20px;
	    border-bottom: 1px solid #22262a;
	    display: flex;
	    justify-content: center;
	}
	.top-nav-content {
	    max-width: 1200px;
	    width: 100%;
	    display: flex;
	    align-items: center;
	    justify-content: space-between;
	}
	.logo {
	    display: flex;
	    align-items: center;
	    gap: 5px;
	}
	.logo .dot { width: 10px; height: 10px; border-radius: 50%; }
	.logo .yellow { background-color: rgb(164, 0, 0); }
	.logo .orange { background-color: rgb(255, 255, 255); }
	.logo .green { background-color: rgb(0, 120, 253); }
	.brand-name { font-size: 20px; font-weight: 700; }
	
	.user-links {
	    display: flex;
	    align-items: center;
	    gap: 10px;
	}
	.user-links form {
	    display: inline-block;
	    margin: 0;
	}
	.user-button {
	    background-color: #22262a;
	    color: #e0e0e0;
	    border: 1px solid #555;
	    border-radius: 5px;
	    padding: 6px 12px;
	    font-size: 14px;
	    font-weight: 500;
	    cursor: pointer;
	    text-transform: uppercase;
	    transition: all 0.2s;
	}
	.user-button:hover {
	    background-color: #333;
	    border-color: #888;
	}

	.profile-header-container {
	    background-color: #22262a;
	    padding: 20px;
	    border-bottom: 1px solid #333;
	    display: flex;
	    justify-content: center;
	}
	.profile-header-content { max-width: 1200px; width: 100%; }
	.profile-info { display: flex; align-items: center; margin-bottom: 20px; }
	.profile-avatar {
	    width: 50px;
	    height: 50px;
	    border-radius: 50%;
	    margin-right: 15px;
	    background-image: url('https://cdn-icons-png.flaticon.com/512/3418/3418886.png');
	    background-size: cover;
	    background-position: center;
	}
	.profile-text .profile-username { font-size: 24px; font-weight: 700; display: block; }
	.profile-text .profile-activity { font-size: 14px; color: #999; }

	.profile-nav {
	    display: flex;
	    gap: 20px;
	    border-bottom: 1px solid #333;
	    padding-bottom: 10px;
	}
	.profile-nav a {
	    color: #999;
	    text-decoration: none;
	    font-size: 14px;
	    font-weight: 500;
	    padding-bottom: 10px;
	    transition: color 0.2s;
	}
	.profile-nav a:hover { color: #fff; }
	.profile-nav a.active {
	    color: #fff;
	    border-bottom: 2px solid #fff;
	    font-weight: 700;
	}

	.movie-catalog-container { max-width: 1200px; width: 100%; margin: 20px auto; padding: 0 20px; }
	.catalog-header {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    padding-bottom: 10px;
	    margin-bottom: 20px;
	    border-bottom: 1px solid #333;
	}
	.catalog-header h3 { font-size: 16px; font-weight: 700; color: #e0e0e0; margin: 0; }

	.catalog-filters {
	    display: flex;
	    gap: 10px;
	    margin-bottom: 20px;
	}
	.catalog-filters select,
	.catalog-filters button {
	    padding: 5px 10px;
	    border-radius: 5px;
	    border: none;
	    background-color: #22262a;
	    color: #e0e0e0;
	}
	.catalog-filters button:hover { background-color: #333; cursor: pointer; }

	.movie-grid {
	    display: grid;
	    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
	    gap: 20px;
	}
	.movie-card {
	    background-color: #1c1c1c;
	    border-radius: 10px;
	    overflow: hidden;
	    display: flex;
	    flex-direction: column;
	    justify-content: space-between;
	    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
	    transition: transform 0.2s ease-in-out;
	    min-height: 420px;
	}
	.movie-card:hover { transform: scale(1.05); }
	.movie-card img {
	    width: 100%;
	    height: 270px;
	    object-fit: cover;
	}
	.movie-info {
	    padding: 10px;
	    display: flex;
	    flex-direction: column;
	    flex-grow: 1;
	}
	.movie-title {
	    font-size: 14px;
	    font-weight: bold;
	    margin: 10px 0 5px;
	    color: #fff;
	    text-align: center;
	}
	.movie-rating {
	    color: #ffcc00;
	    font-size: 14px;
	    text-align: center;
	    margin-bottom: 10px;
	}
	.buttons {
	    display: flex;
	    flex-direction: column;
	    gap: 5px;
	    margin-top: auto;
	}
	.btn {
	    display: inline-block;
	    text-align: center;
	    padding: 8px;
	    border-radius: 8px;
	    text-decoration: none;
	    font-size: 12px;
	    font-weight: bold;
	    transition: background 0.3s;
	}
	.btn-watch { background: #0063e5; color: white; }
	.btn-watch:hover { background: #0483ee; }
	.btn-trailer { background: #333; color: white; }
	.btn-trailer:hover { background-color: #555; }

	.loading-spinner {
	    border: 4px solid #f3f3f3; 
	    border-top: 4px solid #007BFF;
	    border-radius: 50%;
	    width: 30px;
	    height: 30px;
	    animation: spin 1s linear infinite;
	    margin: 20px auto;
	}
	@keyframes spin {
	    0% { transform: rotate(0deg); }
	    100% { transform: rotate(360deg); }
	}
	.load-more {
	    display: block;
	    margin: 30px auto;
	    padding: 10px 20px;
	    background-color: #333;
	    color: #e0e0e0;
	    border: none;
	    border-radius: 5px;
	    cursor: pointer;
	    font-size: 14px;
	}
	.load-more:hover { background-color: #555; }
</style>
</head>
<body>

	<header class="top-nav">
	    <div class="top-nav-content">
	        <div class="logo">
	            <span class="dot yellow"></span>
	            <span class="dot orange"></span>
	            <span class="dot green"></span>
	            <span class="brand-name">MovieMania</span>
	        </div>
	        <div class="user-links">
	            <span th:if="${!userJoinedSession}">
	                <form th:action="@{/login}" method="get">
	                    <button type="submit" class="user-button">ENTRAR</button>
	                </form>
	                <form th:action="@{/cadastro}" method="get">
	                    <button type="submit" class="user-button">CRIAR UMA CONTA</button>
	                </form>
	            </span>
	            <span th:if="${userJoinedSession}">
	                <form th:action="@{/minhas_avaliacoes}" method="get">
	                    <button type="submit" class="user-button">PERFIL</button>
	                </form>
	                <form th:action="@{/logout}" method="post">
	                    <button type="submit" class="user-button">SAIR</button>
	                </form>
	            </span>
				<span th:if="${isAdmin == true}">
				    <form th:action="@{/admin/ver}" method="get">
				        <button type="submit" class="user-button">DASHBOARD</button>
				    </form>
				</span>
	        </div>
	    </div>
	</header>

<div class="profile-header-container">
    <div class="profile-header-content">
        <div class="profile-info">
            <div class="profile-avatar"></div>
            <div class="profile-text">
                <span class="profile-username">MovieMania.com</span>
                <span class="profile-activity">Atividade</span>
            </div>
        </div>
        <nav class="profile-nav">
            <a href="/" class="active">Filmes</a>
            <a href="/minhas_avaliacoes">Minhas avaliações</a>
        </nav>
    </div>
</div>

<main class="movie-catalog-container">
    <div class="catalog-header">
        <h3>PARA AVALIAR</h3>
    </div>

    <div class="catalog-filters">
        <select id="filter-rating">
            <option value="">Avaliação</option>
            <option value="1">★ 1+</option>
            <option value="2">★ 2+</option>
            <option value="3">★ 3+</option>
            <option value="4">★ 4+</option>
            <option value="5">★ 5</option>
        </select>

        <select id="filter-decade">
            <option value="">Década</option>
            <option value="2020">2020s</option>
            <option value="2010">2010s</option>
            <option value="2000">2000s</option>
            <option value="1990">1990s</option>
        </select>

        <select id="filter-genre">
            <option value="">Gênero</option>
            <option value="Action">Ação</option>
            <option value="Comedy">Comédia</option>
            <option value="Drama">Drama</option>
        </select>

        <button id="apply-filters">Filtrar</button>
    </div>

    <div class="movie-grid"></div>
    <div class="loading-spinner" style="display: none;"></div>
    <button class="load-more">Carregar mais</button>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const movieGrid = document.querySelector('.movie-grid');
    const loadMoreBtn = document.querySelector('.load-more');
    const applyFiltersBtn = document.getElementById('apply-filters');
    const loadingSpinner = document.querySelector('.loading-spinner');

    let currentPage = 1;
    let currentFilters = {};

    async function carregarFilmes(page, filters) {
        loadingSpinner.style.display = 'block';
        loadMoreBtn.disabled = true;
        if (page === 1) movieGrid.innerHTML = '';
        const params = new URLSearchParams({ page, ...filters });
        try {
            const response = await fetch(`http://localhost:8080/api/movies/popular?${params.toString()}`);
            const data = await response.json();
            const movies = Array.isArray(data.results) ? data.results : data;
            if (movies && movies.length > 0) {
                exibirFilmes(movies);
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = "Carregar mais";
            } else {
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = "Não há mais filmes";
            }
        } catch (error) {
            console.error('Erro na API:', error);
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = "Erro ao carregar";
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

	function exibirFilmes(movies) {
	    if (currentFilters.rating) {
	        movies.sort((a, b) => (a.vote_average || 0) - (b.vote_average || 0));
	    }

	    movies.forEach(movie => {
	        if (movie.poster_path && movie.id) {
	            const movieCard = document.createElement('div');
	            movieCard.classList.add('movie-card');

	            const img = document.createElement('img');
	            img.src = `https://image.tmdb.org/t/p/w300${movie.poster_path}`;
	            img.alt = movie.title;
	            movieCard.appendChild(img);

	            const info = document.createElement('div');
	            info.classList.add('movie-info');

	            const rating = document.createElement('div');
	            rating.classList.add('movie-rating');
	            rating.textContent = `⭐ ${(movie.vote_average / 2).toFixed(1)}`;

	            const voteCount = document.createElement('div');
	            voteCount.classList.add('movie-votes');
	            voteCount.textContent = `(${movie.vote_count} votos)`;
	            voteCount.style.fontSize = '12px';
	            voteCount.style.color = '#ccc';
	            voteCount.style.textAlign = 'center';

	            info.appendChild(rating);
	            info.appendChild(voteCount);

	            const title = document.createElement('div');
	            title.classList.add('movie-title');
	            title.textContent = movie.title;
	            info.appendChild(title);

	            const buttons = document.createElement('div');
	            buttons.classList.add('buttons');

	            const watchBtn = document.createElement('a');
	            watchBtn.href = `/filme/${encodeURIComponent(movie.id)}`;
	            watchBtn.classList.add('btn', 'btn-watch');
	            watchBtn.textContent = "Avalie agora";
	            buttons.appendChild(watchBtn);

	            info.appendChild(buttons);
	            movieCard.appendChild(info);
	            movieGrid.appendChild(movieCard);
	        }
	    });
	}

    applyFiltersBtn.addEventListener('click', () => {
        currentPage = 1;

        // Converte a escala antes de enviar ao back
        const selectedRating = document.getElementById('filter-rating').value;
        currentFilters.rating = selectedRating ? selectedRating * 2 : "";
        currentFilters.decade = document.getElementById('filter-decade').value;
        currentFilters.genre = document.getElementById('filter-genre').value;

        for (const key in currentFilters) {
            if (currentFilters[key] === "") delete currentFilters[key];
        }

        carregarFilmes(currentPage, currentFilters);
    });

    loadMoreBtn.addEventListener('click', () => {
        currentPage++;
        carregarFilmes(currentPage, currentFilters);
    });

    carregarFilmes(currentPage, currentFilters);
});
</script>

</body>
</html>
